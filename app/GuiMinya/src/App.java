import java.awt.EventQueue;import java.text.SimpleDateFormat;import java.util.Calendar;import javax.swing.JOptionPane;import javax.swing.JTextArea;import javax.swing.text.BadLocationException;import javax.swing.text.Document;import javax.swing.text.Element;import jp.nyatla.minya.MinyaException;import jp.nyatla.minya.MinyaLog;import jp.nyatla.minya.SingleMiningChief;import jp.nyatla.minya.connection.IMiningConnection;import jp.nyatla.minya.connection.StratumMiningConnection;import jp.nyatla.minya.worker.CpuMiningWorker;import jp.nyatla.minya.worker.IMiningWorker;/** * Windowを制御するクラス * @author nyatla * */public class App{	final static String VERSION="GUIMiNya/0.1.1";	class MyLog implements MinyaLog.ILogOutput	{		private MainWindow _ui;		public MyLog(MainWindow i_ui)		{			this._ui=i_ui;		}		@Override		public void println(int level,String s)		{			//メッセージのみ			if(level!=LV_MESSAGE){				return;			}			JTextArea ja=this._ui.log_area;			ja.append(s+"\n");		    final Document doc = ja.getDocument();		    final Element root = doc.getDefaultRootElement();			    EventQueue.invokeLater(new Runnable(){			      @Override public void run() {		    	    try {		    		    for(int i=root.getElementCount()-NUMBER_OF_CONSOLE-1;i>=0;i--){		    	    	    Element fl = root.getElement(0);		    		    	doc.remove(0, fl.getEndOffset());		    		    }					} catch (BadLocationException e){					}			      }			    });		    ja.setCaretPosition(doc.getLength());		}	}	final static String STR_BTN_STOP="Stop Mining";	final static String STR_BTN_START="Start Mining";	private enum State	{		STARTED,		STOPPED	}	private SingleMiningChief _smc;	private State _state;	private MainWindow _ui;	public App(MainWindow i_ui)	{		MinyaLog.setOutput(new MyLog(i_ui));		this._ui=i_ui;		this._state=State.STOPPED;		i_ui.start_button.setText(STR_BTN_START);		MinyaLog.message(			VERSION+"\n"+			"(c)2009 pooler http://www.litecoinpool.org/miner\n"+			"(c)2013 nyatla http://nyatla.jp"		);	}	private final static int NUMBER_OF_CONSOLE=100;/*    private static SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");	public void addLog(String s)	{		JTextArea ja=this._ui.log_area;        //現在日時を取得する        Calendar c = Calendar.getInstance();        //フォーマットパターンを指定して表示する        String d="["+sdf.format(c.getTime())+"]";		ja.append(d+s+"\n");	    final Document doc = ja.getDocument();	    final Element root = doc.getDefaultRootElement();		    EventQueue.invokeLater(new Runnable(){		      @Override public void run() {	    	    try {	    		    for(int i=root.getElementCount()-NUMBER_OF_CONSOLE-1;i>=0;i--){	    	    	    Element fl = root.getElement(0);	    		    	doc.remove(0, fl.getEndOffset());	    		    }				} catch (BadLocationException e){				}	    	  		      }		    });	    ja.setCaretPosition(doc.getLength());	}*/	private void startMining() throws MinyaException	{		String url=(String)this._ui.url_combobox.getSelectedItem();		if(url==null){			JOptionPane.showMessageDialog(null,"Input Stratum server address!\n(ex. stratum+tcp://pool.example.com:5555)");			return;		}		String name=this._ui.worker_name.getText();		if(name.trim().length()==0){			JOptionPane.showMessageDialog(null,"Input Worker name!\n(ex. uid.worker)");			return;		}		String pass=this._ui.worker_password.getText();		if(pass.trim().length()==0){			JOptionPane.showMessageDialog(null,"Input Worker password!");			return;		}		int threads=(Integer)this._ui.thread_spinner.getValue();		//マイナー起動		IMiningConnection mc=new StratumMiningConnection(url,name,pass);		IMiningWorker imw=new CpuMiningWorker(threads);		this._smc=new SingleMiningChief(mc,imw);		this._smc.startMining();		//表記更新		this._ui.start_button.setText(STR_BTN_STOP);		this._ui.thread_spinner.setEnabled(false);		this._ui.url_combobox.setEnabled(false);		this._ui.worker_name.setEnabled(false);		this._ui.worker_password.setEnabled(false);		MinyaLog.message(			"Start Mining\n"+				"Thread :"+threads+"\n"+				"Server :"+url+"\n"+				"Worker :"+name+"@"+pass+"\n"			);		this._state=State.STARTED;		return;	}	private void stopMining() throws MinyaException	{		this._smc.stopMining();		this._ui.start_button.setText(STR_BTN_START);		this._state=State.STOPPED;		this._ui.thread_spinner.setEnabled(true);		this._ui.url_combobox.setEnabled(true);		this._ui.worker_name.setEnabled(true);		this._ui.worker_password.setEnabled(true);				MinyaLog.message("Stop Mining.");		return;	}	public void onStartClick()	{		try{			switch(this._state){			case STOPPED:				this.startMining();				break;			case STARTED:				//マイナー停止				this.stopMining();				break;			default:				break;			}		}catch(Exception e){			JOptionPane.showMessageDialog(null,e.getMessage());			MinyaLog.message("Error!:"+e.getMessage());		}	}	/**	 * アプリケーションを終了するとき	 */	public void finish(){		try{			switch(this._state){			case STARTED:				//マイナー停止				this.stopMining();				break;			default:				break;			}		}catch(MinyaException e){			e.printStackTrace();		}	}		}